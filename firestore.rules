rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the manager
    // TODO: Update this email to your actual manager email
    function isManager() {
      return isAuthenticated() &&
             request.auth.token.email == 'cody.hale@employbridge.com';
    }

    // Helper function to check if submission is locked (after Monday 9 AM)
    function isLocked(weekEnding) {
      // Parse the week ending date (format: YYYY-MM-DD)
      let weekEndDate = timestamp.date(
        int(weekEnding.split('-')[0]),  // year
        int(weekEnding.split('-')[1]),  // month
        int(weekEnding.split('-')[2])   // day
      );

      // Calculate Monday 9 AM after the week ending (Friday + 3 days)
      let lockDate = weekEndDate + duration.value(3, 'd') + duration.value(9, 'h');

      // Check if current time is past the lock date
      return request.time > lockDate;
    }

    // Submissions collection rules
    match /submissions/{submissionId} {

      // Allow authenticated users to read all submissions
      allow read: if isAuthenticated();

      // Allow authenticated users to create new submissions
      allow create: if isAuthenticated() &&
                      request.resource.data.lastUpdatedBy == request.auth.token.email;

      // Allow updates only if:
      // 1. User is authenticated
      // 2. Submission is not locked (before Monday 9 AM)
      // 3. User is updating their own submission OR user is manager
      allow update: if isAuthenticated() &&
                      !isLocked(resource.data.weekEnding) &&
                      (request.resource.data.lastUpdatedBy == request.auth.token.email ||
                       isManager());

      // Only managers can delete submissions
      allow delete: if isManager();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
